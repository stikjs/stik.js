// ==========================================================================
// Project:   Stik.js - JavaScript Separation Of Concerns
// Copyright: Copyright 2013-2014 Lukas Alexandre
// License:   Licensed under MIT license
//            See https://github.com/stikjs/stik.js/blob/master/LICENSE
// ==========================================================================

// Version: 1.0.0 | From: 21-04-2014

if(window.stik)throw"Stik is already loaded. Check your requires ;)";window.stik={},window.stik.injectable=function(spec){function buildModule(dependencies){function TempConstructor(){}var newInstance,value;return TempConstructor.prototype=spec.module.prototype,newInstance=new TempConstructor,value=callWithDependencies(newInstance,dependencies),Object(value)===value?value:newInstance}function resolveDependencies(dependencies){var injector=window.stik.injector({executionUnit:spec.module,modules:dependencies});return injector.resolveDependencies()}function callWithDependencies(context,dependencies){var result=spec.module.apply(context,dependencies);return cacheValue(result),result}function cacheValue(value){spec.cache===!0&&(spec.cachedValue=value)}return spec.instantiable=spec.instantiable||!1,spec.resolvable=spec.resolvable||!1,spec.cache=spec.cache||!1,spec.resolve=function(dependencies){return spec.cachedValue?spec.cachedValue:spec.instantiable===!0?buildModule(resolveDependencies(dependencies)):spec.resolvable===!0?callWithDependencies({},resolveDependencies(dependencies)):spec.module},spec},window.stik.createController=function(spec){if(!spec.name)throw"Stik: Controller needs a name";return spec.actions={},spec.action=function(actionName,executionUnit){var newAction=window.stik.action({name:actionName,controller:spec.name,executionUnit:executionUnit});return spec.actions[actionName]=newAction,newAction},spec.bind=function(modules){var name,boundAny=!1;for(name in spec.actions)spec.actions[name].bind(modules)&&(boundAny=!0);return boundAny},spec},window.stik.action=function(spec){function bindWithTemplate(template){return{context:window.stik.context({controller:spec.controller,action:spec.name,template:template}),executionUnit:spec.executionUnit}}function markAsBound(template){template.className=(template.className+" stik-bound").trim()}if(!spec.controller)throw"Stik: Action needs an controller name";if(!spec.name)throw"Stik: Action name can't be empty";if(!spec.executionUnit)throw"Stik: Action needs a function to use as its execution unit";return spec.bind=function(modules){for(var templates=spec.findTemplates(),i=templates.length;i--;)bindWithTemplate(templates[i]).context.load(spec.executionUnit,modules),markAsBound(templates[i]);return templates.length>0},spec.findTemplates=function(DOMInjection){var DOMHandler=document;DOMInjection&&(DOMHandler=DOMInjection);var selector="[data-controller="+spec.controller+"][data-action="+spec.name+"]:not([class*=stik-bound])";return DOMHandler.querySelectorAll(selector)},spec.bindWithTemplate=bindWithTemplate,spec},window.stik.context=function(spec){function resolveDependencies(executionUnit,modules){var injector=window.stik.injector({executionUnit:executionUnit,modules:modules});return injector.resolveDependencies()}function mergeModules(modules){return modules.$template=spec.template,modules}return spec.template=window.stik.injectable({module:spec.template}),spec.load=function(executionUnit,modules){var dependencies=resolveDependencies(executionUnit,mergeModules(modules));executionUnit.apply(spec,dependencies)},spec},window.stik.createBehavior=function(spec){function bindWithTemplate(template){return{context:window.stik.context({behavior:spec.behavior,template:template}),executionUnit:spec.executionUnit}}function findTemplates(){var selector="[class*="+spec.name+"]:not([data-behaviors*="+spec.name+"])";return document.querySelectorAll(selector)}function markAsApplyed(template){var behaviors=template.getAttribute(behaviorKey);behaviors=((behaviors||"")+" "+spec.name).trim(),template.setAttribute(behaviorKey,behaviors)}if(!spec.name)throw"Stik: Behavior name is missing";if(-1!==spec.name.indexOf(" "))throw"Stik: '"+spec.name+"' is not a valid Behavior name. Please replace empty spaces with dashes ('-')";if(!spec.executionUnit)throw"Stik: Behavior needs a function to use as its execution unit";var behaviorKey="data-behaviors";return spec.bind=function(modules){for(var templates=spec.findTemplates(),i=templates.length;i--;)bindWithTemplate(templates[i]).context.load(spec.executionUnit,modules),markAsApplyed(templates[i]);return templates.length>0},spec.bindWithTemplate=bindWithTemplate,spec.findTemplates=findTemplates,spec},window.stik.createBoundary=function(spec){if(-1!==spec.as.indexOf(" "))throw"Stik: '"+spec.as+"' is not a valid Boundary name. Please replace empty spaces with dashes ('-')";if(!spec.to)throw"Stik: Boundary needs an object or function as 'to'";var obj={};return obj.to=window.stik.injectable({module:spec.to,instantiable:spec.instantiable,resolvable:spec.resolvable,cache:spec.cache}),obj.name=spec.as,obj},window.stik.injector=function(spec){function extractArguments(){var argsPattern,funcString,args;return argsPattern=/^function\s*[^\(]*\(\s*([^\)]*)\)/m,funcString=spec.executionUnit.toString(),args=funcString.match(argsPattern)[1].split(","),trimmedArgs(args)}function trimmedArgs(args){var result=[];return args.forEach(function(arg){result.push(arg.trim())}),result}function grabModules(args){var module,dependencies;if(dependencies=[],1===args.length&&""===args[0])return[];for(var i=0;i<args.length;i++){if(!(module=spec.modules[args[i]]))throw"Stik could not find this module ("+args[i]+")";dependencies.push(module.resolve(spec.modules))}return dependencies}if(!spec.executionUnit)throw"Stik: Injector needs a function to use as its execution unit";return spec.resolveDependencies=function(){var args=extractArguments();return grabModules(args)},spec},window.stik.manager=function(){function storeController(controllerName){var ctrl=window.stik.createController({name:controllerName});return controllers[controllerName]=ctrl,ctrl}function isBehaviorRegistered(name){return!!behaviors[name]}function createBehavior(name,executionUnit){return window.stik.createBehavior(name,executionUnit)}function extractBoundaries(collection){var key,modules={};for(key in collection)modules[key]=collection[key].to;for(key in boundaries.all)modules[key]=boundaries.all[key].to;return modules}function bindController(controller){var modules=extractBoundaries(boundaries.controller);controller.bind(modules)}var behaviors={},controllers={},boundaries={all:{},controller:{},behavior:{}},obj={};return obj.addControllerWithAction=function(controllerName,actionName,executionUnit){var ctrl=storeController(controllerName),action=ctrl.action(actionName,executionUnit);return action.bind(extractBoundaries(boundaries.controller)),ctrl},obj.addController=function(controllerName,executionUnit){var ctrl=storeController(controllerName);return executionUnit.call({},ctrl),bindController(ctrl),ctrl},obj.addBehavior=function(name,executionUnit){if(isBehaviorRegistered(name))throw"Stik: Another behavior already exist with name '"+name+"'";var behavior=createBehavior({name:name,executionUnit:executionUnit});return behaviors[name]=behavior,obj.applyBehavior(behavior),behavior},obj.addBoundary=function(spec){var boundary;if(spec.from=spec.from||"all",-1===["all","controller","behavior"].indexOf(spec.from))throw"Stik: Invalid boundary 'from' specified. Please use 'controller', 'behavior', 'all' or leave it blank to default to 'all'";return boundary=window.stik.createBoundary(spec),boundaries[spec.from][spec.as]=boundary,boundary},obj.applyBehaviors=function(){var behavior,boundAny=!1;for(behavior in behaviors)obj.applyBehavior(behaviors[behavior])&&(boundAny=!0);return boundAny},obj.applyBehavior=function(behavior){var modules=extractBoundaries(boundaries.behavior);return behavior.bind(modules)},obj.bindActionWithTemplate=function(controller,action,template){var result,modules=extractBoundaries(boundaries.controller);return result=controllers[controller].actions[action].bindWithTemplate(template,modules),result.modules=modules,result},obj.bindBehaviorWithTemplate=function(behavior,template){var result,modules=extractBoundaries(boundaries.behavior);return result=behaviors[behavior].bindWithTemplate(template,modules),result.modules=modules,result},obj.bindActions=function(){var ctrl,modules=extractBoundaries(boundaries.controller),boundAny=!1;for(ctrl in controllers)controllers[ctrl].bind(modules)&&(boundAny=!0);return boundAny},obj.getBoundary=function(name){var type,boundaryName;for(type in boundaries)for(boundaryName in boundaries[type])if(boundaryName===name)return boundaries[type][boundaryName]},obj.boundariesFor=function(which){return extractBoundaries(boundaries[which])},obj.$reset=function(){controllers={},behaviors={}},obj},window.stik.$$manager=window.stik.manager(),window.stik.controller=function(controllerName,action,executionUnit){return"string"==typeof action?window.stik.$$manager.addControllerWithAction(controllerName,action,executionUnit):window.stik.$$manager.addController(controllerName,action)},window.stik.behavior=function(name,executionUnit){return window.stik.$$manager.addBehavior(name,executionUnit)},window.stik.lazyBind=window.stik.bindLazy=function(){if(!window.stik.$$manager.bindActions()&!window.stik.$$manager.applyBehaviors())throw"Stik: Nothing new to bind!"},window.stik.boundary=function(spec){return window.stik.$$manager.addBoundary(spec)},window.stik.boundary({as:"$courier",resolvable:!0,cache:!0,to:function(){function fetchSubscriptions(box,callback){var pattern=new RegExp(box);for(var sub in subscriptions)pattern.exec(sub)&&callback(subscriptions[sub])}function unsubscribe(subscription){subscriptions[subscription.box]=subscriptions[subscription.box].filter(function(subs){return subs.id!==subscription.id}),0===subscriptions[subscription.box].length&&delete subscriptions[subscription.box]}function createSubscription(spec){return spec.id="#"+Math.floor(16777215*Math.random()).toString(16),spec}var obj={},subscriptions={};return obj.receive=function(box,opener){var subscription=createSubscription({box:box,opener:opener});return subscriptions[box]=subscriptions[box]||[],subscriptions[box].push(subscription),unsubscribe.bind({},subscription)},obj.send=function(box,message){var i=0,foundAny=!1;if(fetchSubscriptions(box,function(openers){for(foundAny=!0,i=openers.length;i--;)openers[i].opener(message)}),!foundAny)throw"Stik: No receiver registered for '"+box+"'"},obj}}),window.stik.boundary({as:"$viewBag",resolvable:!0,to:function($template){function extractValueOf(element){return isInput(element)?element.value:element.textContent}function updateElementValue(element,value){isInput(element)?element.value=value:element.textContent=value}function fieldsToBind(){return $template.getAttribute(bindingKey)?[$template]:$template.querySelectorAll("["+bindingKey+"]")}function isInput(element){return"INPUT"===element.nodeName.toUpperCase()||"TEXTAREA"===element.nodeName.toUpperCase()}if(!$template)throw"Stik: ViewBag needs a template to be attached to";var obj={},bindingKey="data-key";return obj.push=function(dataSet){for(var dataToBind,fields=fieldsToBind(),i=fields.length;i--;)dataToBind=fields[i].getAttribute(bindingKey),void 0!==dataSet[dataToBind]&&updateElementValue(fields[i],dataSet[dataToBind])},obj.pull=function(){for(var key,fields=fieldsToBind($template),dataSet={},i=fields.length;i--;)key=fields[i].getAttribute(bindingKey),dataSet[key]=extractValueOf(fields[i]);return dataSet},obj}});