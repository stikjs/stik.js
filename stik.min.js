// ==========================================================================
// Project:   Stik.js - JavaScript Separation Of Concerns
// Copyright: Copyright 2013-2014 Lukas Alexandre
// License:   Licensed under MIT license
//            See https://github.com/stikjs/stik.js/blob/master/LICENSE
// ==========================================================================

// Version: 1.0.0 | From: 11-06-2014

if(window.stik)throw"Stik is already loaded. Check your requires ;)";window.stik={},window.stik.injectable=function(spec){function buildModule(dependencies){function TempConstructor(){}var newInstance,value;return TempConstructor.prototype=spec.module.prototype,newInstance=new TempConstructor,value=callWithDependencies(newInstance,dependencies),Object(value)===value?value:newInstance}function resolveDependencies(dependencies){var injector=window.stik.injector({executionUnit:spec.module,modules:dependencies});return injector.resolveDependencies()}function callWithDependencies(context,dependencies){var result=spec.module.apply(context,dependencies);return cacheValue(result),result}function cacheValue(value){spec.cache===!0&&(spec.cachedValue=value)}return spec.instantiable=spec.instantiable||!1,spec.resolvable=spec.resolvable||!1,spec.cache=spec.cache||!1,spec.resolve=function(dependencies){return spec.cachedValue?spec.cachedValue:spec.instantiable===!0?buildModule(resolveDependencies(dependencies)):spec.resolvable===!0?callWithDependencies({},resolveDependencies(dependencies)):spec.module},spec},window.stik.createController=function(spec){if(!spec.name)throw"Stik: Controller needs a name";return spec.actions={},spec.action=function(actionName,executionUnit){var newAction=window.stik.action({name:actionName,controller:spec.name,executionUnit:executionUnit});return spec.actions[actionName]=newAction,newAction},spec.bind=function(modules){var name,boundAny=!1;for(name in spec.actions)spec.actions[name].bind(modules)&&(boundAny=!0);return boundAny},spec},window.stik.action=function(spec){function bindWithTemplate(template){return{context:window.stik.context({controller:spec.controller,action:spec.name,template:template}),executionUnit:spec.executionUnit}}function markAsBound(template){template.className=(template.className+" stik-bound").trim()}if(!spec.controller)throw"Stik: Action needs an controller name";if(!spec.name)throw"Stik: Action name can't be empty";if(!spec.executionUnit)throw"Stik: Action needs a function to use as its execution unit";return spec.bind=function(modules){for(var templates=spec.findTemplates(),i=templates.length;i--;)bindWithTemplate(templates[i]).context.load(spec.executionUnit,modules),markAsBound(templates[i]);return templates.length>0},spec.findTemplates=function(DOMInjection){var DOMHandler=document;DOMInjection&&(DOMHandler=DOMInjection);var selector="[data-controller="+spec.controller+"][data-action="+spec.name+"]:not([class*=stik-bound])";return DOMHandler.querySelectorAll(selector)},spec.bindWithTemplate=bindWithTemplate,spec},window.stik.context=function(spec){function resolveDependencies(executionUnit,modules){var injector=window.stik.injector({executionUnit:executionUnit,modules:modules});return injector.resolveDependencies()}function mergeModules(modules){return modules.$template=spec.template,modules}return spec.template=window.stik.injectable({module:spec.template}),spec.load=function(executionUnit,modules){var dependencies=resolveDependencies(executionUnit,mergeModules(modules));executionUnit.apply(spec,dependencies)},spec},window.stik.createBehavior=function(spec){function bindWithTemplate(template){return{context:window.stik.context({behavior:spec.behavior,template:template}),executionUnit:spec.executionUnit}}function findTemplates(){var selector="[class*="+spec.name+"]:not([data-behaviors*="+spec.name+"])";return document.querySelectorAll(selector)}function markAsApplyed(template){var behaviors=template.getAttribute(behaviorKey);behaviors=((behaviors||"")+" "+spec.name).trim(),template.setAttribute(behaviorKey,behaviors)&removeBehaviorClass(template)}function removeBehaviorClass(template){if(template.classList)template.classList.remove(spec.name);else if(hasClass(template,spec.name)){var regex=new RegExp("(^|\\s)?"+spec.name+"(\\s|$)","g");template.className=template.className.replace(regex," ").trim()}}if(!spec.name)throw"Stik: Behavior name is missing";if(-1!==spec.name.indexOf(" "))throw"Stik: '"+spec.name+"' is not a valid Behavior name. Please replace empty spaces with dashes ('-')";if(!spec.executionUnit)throw"Stik: Behavior needs a function to use as its execution unit";var behaviorKey="data-behaviors";return spec.bind=function(modules){for(var templates=spec.findTemplates(),i=templates.length;i--;)bindWithTemplate(templates[i]).context.load(spec.executionUnit,modules),markAsApplyed(templates[i]);return templates.length>0},spec.bindWithTemplate=bindWithTemplate,spec.findTemplates=findTemplates,spec},window.stik.createBoundary=function(spec){if(-1!==spec.as.indexOf(" "))throw"Stik: '"+spec.as+"' is not a valid Boundary name. Please replace empty spaces with dashes ('-')";if(!spec.to)throw"Stik: Boundary needs an object or function as 'to'";var obj={};return obj.to=window.stik.injectable({module:spec.to,instantiable:spec.instantiable,resolvable:spec.resolvable,cache:spec.cache}),obj.name=spec.as,obj},window.stik.injector=function(spec){function extractArguments(){var argsPattern,funcString,args;return argsPattern=/^function\s*[^\(]*\(\s*([^\)]*)\)/m,funcString=spec.executionUnit.toString(),args=funcString.match(argsPattern)[1].split(","),trimmedArgs(args)}function trimmedArgs(args){var result=[];return args.forEach(function(arg){result.push(arg.trim())}),result}function grabModules(args){var module,dependencies;if(dependencies=[],1===args.length&&""===args[0])return[];for(var i=0;i<args.length;i++){if(!(module=spec.modules[args[i]]))throw"Stik could not find this module ("+args[i]+")";dependencies.push(module.resolve(spec.modules))}return dependencies}if(!spec.executionUnit)throw"Stik: Injector needs a function to use as its execution unit";return spec.resolveDependencies=function(){var args=extractArguments();return grabModules(args)},spec},window.stik.manager=function(){function storeController(controllerName){var ctrl=window.stik.createController({name:controllerName});return controllers[controllerName]=ctrl,ctrl}function isBehaviorRegistered(name){return!!behaviors[name]}function createBehavior(name,executionUnit){return window.stik.createBehavior(name,executionUnit)}function extractBoundaries(collection){var key,modules={};for(key in collection)modules[key]=collection[key].to;for(key in boundaries.all)modules[key]=boundaries.all[key].to;return modules}function bindController(controller){var modules=extractBoundaries(boundaries.controller);controller.bind(modules)}var behaviors={},controllers={},boundaries={all:{},controller:{},behavior:{}},obj={};return obj.addControllerWithAction=function(controllerName,actionName,executionUnit){var ctrl=storeController(controllerName),action=ctrl.action(actionName,executionUnit);return action.bind(extractBoundaries(boundaries.controller)),ctrl},obj.addController=function(controllerName,executionUnit){var ctrl=storeController(controllerName);return executionUnit.call({},ctrl),bindController(ctrl),ctrl},obj.addBehavior=function(name,executionUnit){if(isBehaviorRegistered(name))throw"Stik: Another behavior already exist with name '"+name+"'";var behavior=createBehavior({name:name,executionUnit:executionUnit});return behaviors[name]=behavior,obj.applyBehavior(behavior),behavior},obj.addBoundary=function(spec){var boundary;if(spec.from=spec.from||"all",-1===["all","controller","behavior"].indexOf(spec.from))throw"Stik: Invalid boundary 'from' specified. Please use 'controller', 'behavior', 'all' or leave it blank to default to 'all'";return boundary=window.stik.createBoundary(spec),boundaries[spec.from][spec.as]=boundary,boundary},obj.applyBehaviors=function(){var behavior,boundAny=!1;for(behavior in behaviors)obj.applyBehavior(behaviors[behavior])&&(boundAny=!0);return boundAny},obj.applyBehavior=function(behavior){var modules=extractBoundaries(boundaries.behavior);return behavior.bind(modules)},obj.bindActionWithTemplate=function(controller,action,template){var result,modules=extractBoundaries(boundaries.controller);return result=controllers[controller].actions[action].bindWithTemplate(template,modules),result.modules=modules,result},obj.bindBehaviorWithTemplate=function(behavior,template){var result,modules=extractBoundaries(boundaries.behavior);return result=behaviors[behavior].bindWithTemplate(template,modules),result.modules=modules,result},obj.bindActions=function(){var ctrl,modules=extractBoundaries(boundaries.controller),boundAny=!1;for(ctrl in controllers)controllers[ctrl].bind(modules)&&(boundAny=!0);return boundAny},obj.getBoundary=function(name){var type,boundaryName;for(type in boundaries)for(boundaryName in boundaries[type])if(boundaryName===name)return boundaries[type][boundaryName]},obj.boundariesFor=function(which){return extractBoundaries(boundaries[which])},obj.$reset=function(){controllers={},behaviors={}},obj},window.stik.$$manager=window.stik.manager(),window.stik.controller=function(controllerName,action,executionUnit){return"string"==typeof action?window.stik.$$manager.addControllerWithAction(controllerName,action,executionUnit):window.stik.$$manager.addController(controllerName,action)},window.stik.behavior=function(name,executionUnit){return window.stik.$$manager.addBehavior(name,executionUnit)},window.stik.lazyBind=window.stik.bindLazy=function(){if(!window.stik.$$manager.bindActions()&!window.stik.$$manager.applyBehaviors())throw"Stik: Nothing new to bind!"},window.stik.boundary=function(spec){return window.stik.$$manager.addBoundary(spec)},function(){function withDependencies(){for(var name in modules)tmpDependencies.hasOwnProperty(name)||(tmpDependencies[name]=modules[name]);return tmpDependencies}var helpers={},modules={},tmpDependencies={};window.stik.helper=function(as,func){if(!as)throw"Stik: Helper needs a name";if(!func||"function"!=typeof func)throw"Stik: Helper needs a function";return modules[as]=window.stik.injectable({module:func,resolvable:!0}),helpers[as]=function(){var func=modules[as].resolve(withDependencies());return func.apply({},arguments)},helpers[as]},helpers.pushDoubles=function(doubles){for(var name in doubles)tmpDependencies[name]=window.stik.injectable({module:doubles[name]})},helpers.cleanDoubles=function(){tmpDependencies={}},window.stik.boundary({as:"$h",to:helpers})}(),window.stik.boundary({as:"$window",to:window}),window.stik.helper("$window",function(){return window}),window.stik.helper("isArray",function(){return function(obj){return"[object Array]"===Object.prototype.toString.call(obj)}}),window.stik.helper("debounce",function(){return function(func,wait,immediate){var timeout;return function(){var context=this,args=arguments,later=function(){timeout=null,immediate||func.apply(context,args)},callNow=immediate&&!timeout;clearTimeout(timeout),timeout=setTimeout(later,wait),callNow&&func.apply(context,args)}}}),window.stik.helper("deepExtend",function(){return function(destination,source){for(var property in source)Object.isObjectLiteral(destination[property])&&Object.isObjectLiteral(source[property])?(destination[property]=destination[property]||{},arguments.callee(destination[property],source[property])):destination[property]=source[property];return destination}}),window.stik.helper("zip",function(){return function(firstArray,secondArray){for(var matrix=[],i=0;i<firstArray.length;i++)matrix.push([]),matrix[i].push(firstArray[i]),matrix[i].push(secondArray[i]);return matrix}}),window.stik.boundary({as:"$viewBag",resolvable:!0,to:function($template){function extractValueOf(element){return isInput(element)?element.value:element.textContent}function updateElementValue(element,value){isInput(element)?element.value=value:element.textContent=value}function fieldsToBind(){return $template.getAttribute(bindingKey)?[$template]:$template.querySelectorAll("["+bindingKey+"]")}function isInput(element){return"INPUT"===element.nodeName.toUpperCase()||"TEXTAREA"===element.nodeName.toUpperCase()}if(!$template)throw"Stik: ViewBag needs a template to be attached to";var obj={},bindingKey="data-key";return obj.push=function(dataSet){for(var dataToBind,fields=fieldsToBind(),i=fields.length;i--;)dataToBind=fields[i].getAttribute(bindingKey),void 0!==dataSet[dataToBind]&&updateElementValue(fields[i],dataSet[dataToBind])},obj.pull=function(){for(var key,fields=fieldsToBind($template),dataSet={},i=fields.length;i--;)key=fields[i].getAttribute(bindingKey),dataSet[key]=extractValueOf(fields[i]);return dataSet},obj}}),window.stik.boundary({as:"$courier",resolvable:!0,cache:!0,to:function(){function fetchSubscriptions(box,callback){var receiverPattern,senderPattern=new RegExp(box);for(var name in subscriptions)receiverPattern=new RegExp(stringify(name)),(senderPattern.exec(stringify(name))||receiverPattern.exec(stringify(box)))&&callback(subscriptions[name])}function unsubscribe(subscription){subscriptions[subscription.box]=subscriptions[subscription.box].filter(function(subs){return subs.id!==subscription.id}),0===subscriptions[subscription.box].length&&delete subscriptions[subscription.box]}function createSubscription(spec){return spec.id="#"+Math.floor(16777215*Math.random()).toString(16),spec}function stringify(name){return name.toString().replace(/(^\/|\/$)/g,"")}var obj={},subscriptions={};return obj.receive=function(box,opener){var subscription=createSubscription({box:stringify(box),opener:opener});return subscriptions[box]=subscriptions[box]||[],subscriptions[box].push(subscription),unsubscribe.bind({},subscription)},obj.send=function(box,message){var i=0,foundAny=!1;if(fetchSubscriptions(box,function(openers){for(foundAny=!0,i=openers.length;i--;)openers[i].opener(message)}),!foundAny)throw"Stik: No receiver registered for '"+box+"'"},obj.reset=function(){subscriptions={}},obj}}),function(window){function withDependencies(){for(var name in modules)tmpDependencies.hasOwnProperty(name)||(tmpDependencies[name]=modules[name]);return tmpDependencies}var methods={},modules={},tmpDependencies={};window.stik.dom=function(as,func){if(!as)throw"Stik: DOM needs a name";if(!func||"function"!=typeof func)throw"Stik: DOM needs a function";return modules[as]=window.stik.injectable({module:func,resolvable:!0}),methods[as]=function(){var func=modules[as].resolve(withDependencies());return func.apply({},arguments)},methods[as]},methods.pushDoubles=function(doubles){for(var name in doubles)tmpDependencies[name]=window.stik.injectable({module:doubles[name]})},methods.cleanDoubles=function(){tmpDependencies={}},window.stik.boundary({as:"$dom",to:methods})}(window),window.stik.dom("hasClass",function(){return function(elm,selector){if(elm.classList)return elm.classList.contains(selector);var className=" "+selector+" ";return(" "+elm.className+" ").replace(/[\t\r\n\f]/g," ").indexOf(className)>=0}}),window.stik.dom("removeClass",function(hasClass){return function(elm,className){var classNames=[];classNames="[object Array]"===Object.prototype.toString.call(className)?className:className.split(" ");for(var i=0;i<classNames.length;i++)if(elm.classList)elm.classList.remove(classNames[i]);else if(hasClass(elm,classNames[i])){var regex=new RegExp("(^|\\s)?"+classNames[i]+"(\\s|$)","g");elm.className=elm.className.replace(regex," ").trim()}}}),window.stik.dom("addClass",function(hasClass){return function(elm,className){var classNames=[];classNames="[object Array]"===Object.prototype.toString.call(className)?className:className.split(" ");for(var i=0;i<classNames.length;i++)hasClass(elm,classNames[i])||(elm.classList?elm.classList.add(classNames[i]):elm.className=(elm.className+" "+classNames[i]).trim())}}),window.stik.dom("toggleClass",function(hasClass,addClass,removeClass){return function(elm,selector,forceAdd){forceAdd===!0?addClass(elm,selector):forceAdd===!1?removeClass(elm,selector):hasClass(elm,selector)?removeClass(elm,selector):hasClass(elm,selector)||addClass(elm,selector)}}),window.stik.dom("hide",function(){return function(elm){elm.style.display="none"}}),window.stik.dom("isHidden",function(){return function(elm){return null===elm.offsetParent}}),window.stik.dom("isVisible",function(isHidden){return function(elm){return!isHidden(elm)}}),window.stik.dom("show",function(){return function(elm){elm.style.display="block"}}),window.stik.dom("remove",function(){return function(elm){elm.parentNode.removeChild(elm)}}),window.stik.dom("parse",function(){return function(elmStr){var tmp=document.implementation.createHTMLDocument();return tmp.body.innerHTML=elmStr,tmp.body.children>1?tmp.body.childNodes:tmp.body.firstChild}}),window.stik.dom("append",function(){return function(parent,newChild){if("string"==typeof newChild){var div=document.createElement("div");for(div.innerHTML=newChild;div.firstChild;)parent.appendChild(div.firstChild)}else parent.appendChild(newChild)}}),window.stik.dom("prepend",function(insertBefore,append){return function(parent,newChild){parent.childNodes.length>0?insertBefore(parent.firstChild,newChild):append(parent,newChild)}}),window.stik.dom("insertAfter",function(){return function(referenceNode,newChild){"string"==typeof newChild?referenceNode.insertAdjacentHTML("afterend",newChild):referenceNode.parentNode.insertBefore(newChild,referenceNode.nextSibling)}}),window.stik.dom("insertBefore",function(){return function(referenceNode,newChild){"string"==typeof newChild?referenceNode.insertAdjacentHTML("beforebegin",newChild):referenceNode.parentNode.insertBefore(newChild,referenceNode)}}),window.stik.dom("data",function(){return function(elm){function parseName(name){return toCamelCase(name.match(/(data-)(.+)/)[2])}function toCamelCase(name){return name.replace(/-([a-z])/g,function(match){return match[1].toUpperCase()})}var attr,name,attrs={};for(attr in elm.attributes)elm.attributes[attr].value&&(name=elm.attributes[attr].name,name.match(/^data-/m)&&(attrs[parseName(name)]=elm.attributes[attr].value));return attrs}}),window.stik.dom("contains",function(){return function(elm,child){return"string"==typeof child?null!==el.querySelector(selector):elm!==child&&elm.contains(child)}}),window.stik.dom("filter",function(){return function(elm,selector){return Array.prototype.filter.call(elm.querySelectorAll(selector),filterFn)}}),window.stik.dom("position",function(){return function(elm){return{left:elm.offsetLeft,top:elm.offsetTop}}}),window.stik.dom("siblings",function(){return function(elm){return Array.prototype.filter.call(elm.parentNode.children,function(child){return child!==elm})}}),window.stik.boundary({as:"$data",resolvable:!0,to:function($template,$dom){return $dom.data($template)}}),window.stik.dom("serialize",function(){return function(form){var i,j,q;if(form&&"FORM"===form.nodeName){for(i=j=void 0,q=[],i=form.elements.length-1;i>=0;)if(""!==form.elements[i].name){switch(form.elements[i].nodeName){case"INPUT":switch(form.elements[i].type){case"text":case"hidden":case"password":case"button":case"reset":case"submit":q.push(form.elements[i].name+"="+encodeURIComponent(form.elements[i].value));break;case"checkbox":case"radio":form.elements[i].checked&&q.push(form.elements[i].name+"="+encodeURIComponent(form.elements[i].value));break;case"file":}break;case"TEXTAREA":q.push(form.elements[i].name+"="+encodeURIComponent(form.elements[i].value));break;case"SELECT":switch(form.elements[i].type){case"select-one":q.push(form.elements[i].name+"="+encodeURIComponent(form.elements[i].value));break;case"select-multiple":for(j=form.elements[i].options.length-1;j>=0;)form.elements[i].options[j].selected&&q.push(form.elements[i].name+"="+encodeURIComponent(form.elements[i].options[j].value)),j-=1}break;case"BUTTON":switch(form.elements[i].type){case"reset":case"submit":case"button":q.push(form.elements[i].name+"="+encodeURIComponent(form.elements[i].value))}}i-=1}else i-=1;return q.join("&")}}}),window.stik.boundary({as:"$url",resolvable:!0,to:function($window){return{baseUrl:function(){return $window.location.href},relativeUrl:function(){return this.baseUrl.match(/http:\/\/.+?(\/.+$)/)[1]},pathName:function(){return $window.location.pathname},hash:function(newHashValue){return this.locationHash(newHashValue).replace(/^#/,"")},locationHash:function(newHashValue){return newHashValue&&($window.location.hash=newHashValue),location.hash},mainPath:function(){return"/"+this.pathName().split("/")[1]},goTo:function(url){$window.location=url},queries:function queries(){var result,queries,query;if(queries=this.baseUrl().split("?")[1]){queries=queries.split("&"),result={};for(var i=0;i<queries.length;i++)query=queries[i].split("="),result[query[0]]=query[1];return result}return{}}}}}),window.stik.labs={},window.stik.labs.behavior=function(spec){function parseAsDOM(){var container=document.implementation.createHTMLDocument();return container.body.innerHTML=spec.template,container.body.firstChild}function mergeModules(doubles){for(var dbl in doubles)result.modules[dbl]=window.stik.injectable({module:doubles[dbl]});return result.modules}if(!spec)throw"Stik: Behavior Lab needs an environment to run";if(!spec.name)throw"Stik: Behavior Lab needs a name";if(!spec.template)throw"Stik: Behavior Lab needs a template";var result,env={};return env.template=parseAsDOM(),result=window.stik.$$manager.bindBehaviorWithTemplate(spec.name,env.template),env.run=function(doubles){result.context.load(result.executionUnit,mergeModules(doubles))},env},window.stik.labs.boundary=function(spec){function mergeModules(doubles){var modules=window.stik.$$manager.boundariesFor("behavior");for(var dbl in doubles)modules[dbl]=window.stik.injectable({module:doubles[dbl]});return modules}if(!spec)throw"Stik: Boundary Lab needs an environment to run";if(!spec.name)throw"Stik: Boundary Lab needs a name";var env={},boundary=window.stik.$$manager.getBoundary(spec.name);return env.run=function(doubles){return boundary.to.resolve(mergeModules(doubles))},env},window.stik.labs.controller=function(spec){function parseAsDOM(){var container=document.implementation.createHTMLDocument();return container.body.innerHTML=spec.template,container.body.firstChild}function mergeModules(doubles){for(var dbl in doubles)result.modules[dbl]=window.stik.injectable({module:doubles[dbl]});return result.modules}if(!spec)throw"Stik: Controller Lab needs an environment to run";if(!spec.name)throw"Stik: Controller Lab needs a name";if(!spec.action)throw"Stik: Controller Lab needs the action name";if(!spec.template)throw"Stik: Controller Lab needs a template";var result,env={};return env.template=parseAsDOM(),result=window.stik.$$manager.bindActionWithTemplate(spec.name,spec.action,env.template),env.run=function(doubles){result.context.load(result.executionUnit,mergeModules(doubles))},env},window.stik.labs.helper=function(spec){if(!spec)throw"Stik: Helper Lab needs an environment to run";if(!spec.name)throw"Stik: Helper Lab needs a name";var env={},boundary=window.stik.labs.boundary({name:"$h"});return env.run=function(doubles){var helpers=boundary.run(doubles);return helpers.pushDoubles(doubles),function(){return helpers[spec.name].apply({},arguments)}},env},window.stik.labs.dom=function(spec){if(!spec)throw"Stik: Helper Lab needs an environment to run";if(!spec.name)throw"Stik: Helper Lab needs a name";var env={},boundary=window.stik.labs.boundary({name:"$dom"});return env.run=function(doubles){var methods=boundary.run(doubles);return methods.pushDoubles(doubles),function(){return methods[spec.name].apply({},arguments)}},env};